name: ubuntu-server-amd64
version: "24.04.20241217"
base: bare
build-base: ubuntu@24.04
platforms:
  amd64:

volumes:
  pc:
    schema: gpt
    structure:
      - name: efi
        type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
        filesystem: vfat
        role: system-boot
        filesystem-label: UEFI
        size: 256M
      - name: rootfs
        type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
        filesystem: ext4
        filesystem-label: writable
        role: system-data
        size: 5G

filesystems:
  default:
    - mount: "/"
      device: "(volume/pc/rootfs)" # Will map to the default partition
    - mount: "/boot/efi"
      device: "(volume/pc/efi)"

parts:
  rootfs:
    plugin: nil
    build-packages: ["mmdebstrap"]
    overlay-script: |
      # Populate the overlay manually because we do not have the 
      # feature to use `organize` targeting the overlay
      mmdebstrap --arch $CRAFT_ARCH_BUILD_FOR \
       --mode=sudo \
       --format=dir \
       --variant=minbase \
       --include=apt \
       noble \
       $CRAFT_OVERLAY/ \
       http://archive.ubuntu.com/ubuntu/
  packages:
    plugin: nil
    after: [rootfs]
    overlay-script: |
      # Use on overlay-script because we cannot install overlay-packages on top
      # of the layer created by the `rootfs` part yet. 
      # Install packages and populate contents in /boot/efi/
      test -d $CRAFT_OVERLAY/boot
      mkdir $CRAFT_OVERLAY/boot/efi/
      echo "test" > $CRAFT_OVERLAY/boot/efi/test

